#!/usr/bin/env python3
# from https://cryptohack.org/challenges/introduction/

import telnetlib
import json
import secrets
from passlib.hash import argon2
import itertools
from Crypto.Hash import MD5, HMAC, SHA256, SHA1
import subprocess
from Crypto.Hash import HMAC, SHA256, SHA512
from Crypto.Protocol.KDF import HKDF
from Crypto.Cipher import AES
from string import ascii_letters, digits
from itertools import product
import numpy as np
import math
import decimal
from Crypto.Util.number import inverse, GCD, getPrime, bytes_to_long, long_to_bytes
from Crypto.Cipher import PKCS1_OAEP
from Crypto.Random import get_random_bytes
from Crypto.PublicKey import ElGamal
from Crypto.PublicKey import RSA
import time
from elgamal import ElGamalImpl
from random import randint

RANDOM = get_random_bytes(4096)

ALPHABET = ascii_letters + digits

tn = telnetlib.Telnet("aclabs.ethz.ch", 50902)
# tn = telnetlib.Telnet("localhost", 50902)
block_size = 16
key_size = 16


def xor(x: bytes, y: bytes):
    return bytes(a ^ b for a, b in zip(x, y))


def readline():
    return tn.read_until(b"\n")


def json_recv():
    line = readline()
    return json.loads(line.decode())


def json_send(req):
    request = json.dumps(req).encode()
    tn.write(request + b"\n")


def extended_gcd(a, b):
    if a == 0:
        return b, 0, 1
    else:
        gcd, x, y = extended_gcd(b % a, a)
        return gcd, y - (b // a) * x, x


json_send({"command": "get_public_parameters"})
res = json_recv()
print(res)
p_server = int(res["p"])

# key = ElGamal.generate((4096), randfunc=lambda n: RANDOM)
# p = getPrime(4096)*
p = 655292382184668419619427636342580916968270739605769855584595049117486139028707305324088068867542572747076448864148087634643587877087265282129351026546886549485226790899337775598791578277277933505692325619523562068870189071080921814924435862463931592242587938754042208712367842236792369904575791335491544824084766341823234545708275800416281234507475620317139320886648020055046214888088850030357570792758957723346307606319869081484102066829633798799059856777528012291948186721168533333388665759506917008506020601981008863725948591115030434451812121980290163339726623845232204631091302214579267858893544282172403118032268373681660567243395044565927568943875818207399085043427432088784975818514326791825804624468291088783858538733471761547741547305931032191237399179505057289569830005287035555813358948047170350249575322894660159619022699711255290339153055763891919922369288602132277259156399197035587840264057115259888292028127158865934724618785233477205673631202817458511034348509732157659308319307669793075797771870363964064234204697054207835469360407188754542135489720421938268151771688008476827997528688415594247604407139041103790796360547469686485474770194497671436581445819841375435645502962336855597340827378999929449963737674663
g = 574605094392585122806426265087443840413542114238888058086249822200787197215461170132346840120638951377679139527170202368919822551827103907811364881507531976406030427015460154556841465522656359402491475621553464828144963889473607979847796287026156272168837764780290303134102552771479780495726063901795478126513498957416483338874107987930055217328144346233062924720697552975426557030892620944820075085267081835076408491587575213857485300263625295101445149977910734033763602430739450065281063116234272077694949411484741944861270868733486339402298674766071194782284035765041775824988241494770831981839145814164624174774780834045347553656043561368075674486953143779067935085814716366218083997306893060933942557333557143504565860928164852321238330860524238856987680822564592050284675340530254819392930292922255543440937608115980964370860179846519686344591189877459443786306696609773782970470313834762671538494245632460916820947081548293334395882337625997744117801621734984537530523648066652083702544970113279250092469594456065963241781725082917735254507629334205836815972348287146712697864276111673669375808018739176779106576733846673537443638948284304986344269734912433489112832718154566560400462593424814644542339336848982906015624476581
x = 4
y = pow(g, x, p)

json_send({"command": "set_response_key", "p": p, "g": g, "y": y})
res = json_recv()
print(res)
key = ElGamal.construct((p, g, y, x))
res_received = b"aa"
expected_res = b"Th"
i = 0
while not (expected_res[0] == res_received[0] and expected_res[1] == res_received[1]):
    i += 1

    json_send(
        {
            "command": "encrypted_command",
            "encrypted_command": {"c1": "02", "c2": "01"},
        }
    )
    res = json_recv()
    print(res)
    c1_res, c2_res = res["encrypted_res"]["c1"], res["encrypted_res"]["c2"]
    full_res = ElGamalImpl.decrypt(key, bytes.fromhex(c1_res), bytes.fromhex(c2_res))
    print(full_res[0])
    res_received = full_res[0:2]

new_res = full_res
print(new_res)
result = b"Q\xdde\x8f\xaa7\xc8O\x10\xf3cD\xf2\xdfK\t\xeb\x90A\x85\x11\xd3\x1f*\x12\xfbRMF\x0b/\x0c\xc0/|\x95\xc9\xef\xe9\xda\xb8>\xdc\xbd0&\x82!\x1a\x86\xad6\xa2LR\x10\x838jJ\xfb7}\x85\xf6\x86v\x12\xd8@\xfc\xc4`\xe8\xd3\x81\xe0\xa6Hc1\x08\xa2\x0c\xba\xcd\x1eF\xee\xb5[\xf9OT\x88iz\x19\xbcE\x87\\A\x10\xfe\x1ef\xf3\x06z\x1f\xb8h\xd4\xa6\xcb\xb9\xea\xba\xcbqQ0\x02\x17o\xce1"
message = "backdoor".encode()
cipher = (inverse(bytes_to_long(result), p_server) * bytes_to_long(message)) % p_server
json_send(
    {
        "command": "encrypted_command",
        "encrypted_command": {"c1": "02", "c2": long_to_bytes(cipher).hex()},
    }
)
res = json_recv()
print(res)
c1_res, c2_res = res["encrypted_res"]["c1"], res["encrypted_res"]["c2"]
full_res = ElGamalImpl.decrypt(key, bytes.fromhex(c1_res), bytes.fromhex(c2_res))
print(full_res)
